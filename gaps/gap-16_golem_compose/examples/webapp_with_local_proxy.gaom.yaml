payloads:
  web-server:
    runtime: vm
    params:
      image_hash: "c37c1364f637c199fe710ca62241ff486db92c875b786814c6030aa1"

  db-server:
    runtime: vm
    params:
      image_hash: "85021afecf51687ecae8bdc21e10f3b11b82d2e3b169ba44e177340c"

  local-proxy:
    runtime: local-http-proxy

networks:
  default:
    ip: "192.168.0.1/24"

services:
  db-service:
    payload: db-server
    network: default
    init:
        - run:
            args: ["/bin/run_rqlite.sh"]

  web-server-service:
    payload: web-server
    network: default
    depends_on:
      - db-service
    init:
      # ...see how attributes extracted from 'db-service' provisioned above are used to populate the arguments of the 'web-server-service'
      - run:
          args: ["/bin/bash", "-c", "cd /webapp && python app.py --db-address ${services.db-service.network_node.ip} --db-port 4001 initdb"]
      - run:
          args: ["/bin/bash", "-c", "cd /webapp && python app.py --db-address ${services.db-service.network_node.ip} --db-port 4001 run > /webapp/out 2> /webapp/err &" ]
  
  local-proxy:
    payload: local-proxy
    network: default
    port: 8080
    remote-endpoints:
      - ip: "${services.web-server-service[0].network_node.ip}"
        port: 80
      - ip: "${services.web-server-service[1].network_node.ip}"
        port: 80



